{% extends "base.html" %}

{% block content %}

<script src="/static/js/jquery.js"></script>
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/spin.min.js"></script>
<script src="/static/js/jquery-ui-1.10.3.custom.min.js"></script>
<script src="/static/js/masses.js"></script>


<script type="text/javascript">
var opts = {
  lines: 13, // The number of lines to draw
  length: 20, // The length of each line
  width: 10, // The line thickness
  radius: 30, // The radius of the inner circle
  corners: 1, // Corner roundness (0..1)
  rotate: 0, // The rotation offset
  direction: 1, // 1: clockwise, -1: counterclockwise
  color: '#000', // #rgb or #rrggbb
  speed: 1, // Rounds per second
  trail: 46, // Afterglow percentage
  shadow: true, // Whether to render a shadow
  hwaccel: false, // Whether to use hardware acceleration
  className: 'spinner', // The CSS class to assign to the spinner
  zIndex: 2e9, // The z-index (defaults to 2000000000)
  top: 'auto', // Top position relative to parent in px
  left: 'auto' // Left position relative to parent in px
};

var global_data;

function refilter(fathers_list)
{
  if(fathers_list.length == 0) {
    $(".decay").show();
    return;
  }

  $(".decay").hide();

  for(var f in fathers_list) {
    var father = fathers_list[f];
    $('tr[class|="decay father-'+father+'"]').show();
  }
  return;
}

function show_results(data)
{
    for ( var i in data['result']) {
      var result = data['result'][i];
      var father = data['result'][i]['father'];

      $('#results tr:last').after("<tr class=\"decay father-"+father+"\">\
      <td>"+ (father in masses ? masses[father][0] : "Dunno") +"</td>\
      <td>"+ result['branching'][0] +"</td>\
      <td>"+ result['scheme'] +"</td>\
      </tr>");
    }

    $("#search_results").append("<hr/><p>Generated in "+ data['time'] +"</p>");
}

function create_filters(data)
{
  var fathers = {};

  for ( var i in data['result']) 
  {
      var father = data['result'][i]['father'];
      if(father in fathers)
        continue;

      fathers[father] = true;
  }

  var availableTags = Object.keys(fathers);

  function split( val ) {
    return val.split( /,\s*/ );
  }
  function extractLast( term ) {
    return split( term ).pop();
  }

  $( "#tags" )
    // don't navigate away from the field on tab when selecting an item
    .bind( "keydown", function( event ) {
      if ( event.keyCode === $.ui.keyCode.TAB &&
          $( this ).data( "ui-autocomplete" ).menu.active ) {
        event.preventDefault();
      }
    })
    .autocomplete({
      minLength: 0,
      source: function( request, response ) {
        // delegate back to autocomplete, but extract the last term
        response( $.ui.autocomplete.filter(
          availableTags, extractLast( request.term ) ) );
      },
      focus: function() {
        // prevent value inserted on focus
        return false;
      },
      select: function( event, ui ) {
        var terms = split( this.value );
        // remove the current input
        terms.pop();
        // add the selected item
        terms.push( ui.item.value );
        refilter(terms);
        // add placeholder to get the comma-and-space at the end
        terms.push( "" );
        this.value = terms.join( ", " );

        return false;
      }
    });

}

function do_search()
{
  var query = $("#query").val();
  if (query == "") return;

  $("#about").hide();

  var target = document.getElementById('loading');
  var spinner = new Spinner(opts).spin(target);

  $.getJSON('/' + query + '.json', function(data) {
    $("#loading").hide();
    $("#search_results").removeClass('hidden');
    
    global_data = data;
    show_results(data);
    create_filters(data);

  });
}
</script>


<div class="row">
  <div class="span12">

    <div id="about" class="span6 offset3">
        <p>Dear colleagues, we are happy to greet you at the closed &beta;-test of  <strong>fstate</strong> project, which allow to find decays by the final state.</p>
        <p>At this moment you can try to search decays with up to 5 particles in the final state (try pi+ pi- mu+ mu-, for example). More powerfull search is expected soon.</p>
        <p>If you have some comments or see a bug, we would appreciate if you could <a href="mailto:ilya.komarov@epfl.ch,a.baranov@cern.ch?Subject=fstate%20feedback">
          write</a> us about it.</p>
    </div>

    <div id="loading"></div>

    <div id="search_results" class="hidden">
      <div class="ui-widget">
        <label for="tags">Filter by fathers: </label>
        <input id="tags" size="50" />
      </div>
      <hr/>
      <span id="res_table">
        <table id="results" class="table-striped">
          <tr>
              <td><strong>Father mass, MeV</strong></td>
              <td><strong>Approximate branching fraction &darr;</strong></td>
              <td><strong>Mode</strong></td>
          </tr>
        </table>
      </span>
    </div>
</div>


<script type="text/javascript">
$("#query").keyup(function(event){
    if(event.keyCode == 13){
        do_search();
    }
});

$(function() {
 
  });
</script>

{% endblock %}
